(()=>{"use strict";window.util={escPress:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},removeAdPins:()=>{document.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()}))}},window.debounce=function(e){let t=null;return function(){t&&window.clearTimeout(t),t=window.setTimeout((function(){e()}),500)}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o=(e,t,o,r)=>{const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(()=>{200===n.status?o(n.response):r(`Статус ответа: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e4,n.open(e,t),n};window.backend={load:(t,r)=>{o("GET",e,t,r).send()},save:(e,r,n)=>{o("POST",t,r,n).send(e)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.renderPin=t=>{const o=e.cloneNode(!0),r=o.querySelector("img");return o.style=`left: ${t.location.x-25}px; top: ${t.location.y-70}px;`,r.src=t.author.avatar,r.alt=t.offer.title,o}})(),(()=>{const e=["gif","jpg","jpeg","png"],t={1:"«для 1 гостя»",2:"«для 2 гостей» или «для 1 гостя»",3:"«для 3 гостей, «для 2 гостей» или «для 1 гостя»",100:"«не для гостей»"},o={BUNGALOW:"0",FLAT:"1000",HOUSE:"5000",PALACE:"10000"},r=document.querySelector(".ad-form"),n=r.querySelector("#title"),a=r.querySelector("#room_number"),i=r.querySelector("#capacity"),d=r.querySelector("#type"),c=r.querySelector("#price"),s=r.querySelector("#timein"),l=r.querySelector("#timeout"),u=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),p=u.querySelector(".error__button"),m=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),f=r.querySelector(".ad-form__reset"),y=document.querySelector(".ad-form__field input[type=file]"),v=document.querySelector(".ad-form-header__preview"),w=document.querySelector(".ad-form__upload input[type=file]"),_=document.querySelector(".ad-form__photo"),h=(t,o)=>{const r=t.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{if(o.firstChild){const t=o.firstElementChild;"IMG"===t.tagName&&(t.src=e.result)}else{const t=document.createElement("img");t.src=e.result,t.width=70,t.height=70,o.append(t)}})),e.readAsDataURL(r)}},S=e=>{window.util.escPress(e,E)},q=e=>{window.util.escPress(e,L)},E=()=>{u.remove(),document.removeEventListener("keydown",S)},L=()=>{m.remove(),document.removeEventListener("keydown",q)},g=()=>{document.body.insertAdjacentElement("afterbegin",u),p.addEventListener("click",(()=>{E()})),document.addEventListener("keydown",S),u.addEventListener("click",(()=>{E()}))},A=()=>{window.util.removeAdPins(),window.map.map.contains(window.map.map.querySelector(".map__card"))&&window.map.map.querySelector(".map__card").remove(),r.reset(),window.map.disablePage()},k=()=>{let e="";const o=Number(a.value),r=Number(i.value);(e=>e<=3?[1,e]:[0])(o).includes(r)||(e=t[o]),i.setCustomValidity(e)},C=()=>{c.min=o[d.value.toUpperCase()],c.placeholder=o[d.value.toUpperCase()]};n.addEventListener("input",(()=>{const e=n.value.length;e<30?n.setCustomValidity(`Еще ${30-e} симв.`):e>100?n.setCustomValidity(`Удалите лишние ${e-100} симв.`):n.setCustomValidity("")})),a.addEventListener("change",k),i.addEventListener("change",k),d.addEventListener("change",C),s.addEventListener("change",(()=>{l.value=s.value})),l.addEventListener("change",(()=>{s.value=l.value})),r.addEventListener("submit",(e=>{window.backend.save(new FormData(r),(()=>{document.body.insertAdjacentElement("afterbegin",m),document.addEventListener("keydown",q),m.addEventListener("click",(()=>{L()})),A()}),g),e.preventDefault()})),f.addEventListener("click",(()=>{A()})),y.addEventListener("change",(()=>{h(y,v)})),w.addEventListener("change",(()=>{h(w,_)})),window.form={adForm:r,onValidateGuests:k,onValidatePrice:C}})(),(()=>{const e={FLAT:"Квартира",BUNGALOW:"Бунгало",HOUSE:"Дом",PALACE:"Дворец",getById:t=>e[t.toUpperCase()]},t={WIFI:"wifi",DISHWASHER:"dishwasher",PARKING:"parking",WASHER:"washer",ELEVATOR:"elevator",CONDITIONER:"conditioner"},o=document.querySelector("#card").content.querySelector(".map__card"),r=e=>{0===e.children.length&&e.remove()};window.renderCard=n=>{const a=o.cloneNode(!0),i=a.querySelector(".popup__features"),d=a.querySelector(".popup__photos"),c=d.querySelector(".popup__photo"),s=a.querySelector(".popup__title"),l=a.querySelector(".popup__text--address"),u=a.querySelector(".popup__text--price"),p=a.querySelector(".popup__type"),m=a.querySelector(".popup__text--capacity"),f=a.querySelector(".popup__text--time"),y=a.querySelector(".popup__description"),v=a.querySelector(".popup__avatar");s.textContent=n.offer.title,l.textContent=n.offer.address,u.textContent=n.offer.price+"₽/ночь",p.textContent=e.getById(n.offer.type),m.textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,f.textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`;for(let e in t)n.offer.features.includes(t[e])||i.removeChild(i.querySelector(".popup__feature--"+t[e]));return y.textContent=n.offer.description,d.querySelectorAll(".popup__photo").forEach((e=>{d.removeChild(e)})),n.offer.photos.forEach((e=>{const t=c.cloneNode(!0);d.appendChild(t),t.src=e})),v.src=n.author.avatar,r(i),r(d),a}})(),(()=>{const e="any",t={low:{MIN:0,MAX:1e4},middle:{MIN:1e4,MAX:5e4},high:{MIN:5e4,MAX:1/0}},o=document.querySelector(".map__filters"),r=o.querySelector("#housing-type"),n=o.querySelector("#housing-price"),a=o.querySelector("#housing-rooms"),i=o.querySelector("#housing-guests"),d=o.querySelector("#housing-features"),c=o=>n.value===e||t[n.value].MIN<=o.offer.price&&t[n.value].MAX>=o.offer.price,s=t=>a.value===e||String(t.offer.rooms)===a.value,l=t=>i.value===e||String(t.offer.guests)===i.value,u=e=>{const t=d.querySelectorAll("input:checked");let o=!0;return t.forEach((t=>{o=o&&e.offer.features.includes(t.value)})),o};window.filter={mapForm:o,getFilterAds:t=>{const o=[];for(let a=0;a<t.length&&5!==a;a++)n=t[a],(r.value===e||n.offer.type===r.value)&&c(t[a])&&s(t[a])&&l(t[a])&&u(t[a])&&o.push(t[a]);var n;return o}}})(),(()=>{const e=65,t=document.querySelector(".map"),o=t.querySelector(".map__pins"),r=t.querySelector(".map__filters-container"),n=document.querySelector(".map__pin--main"),a=window.form.adForm,i=a.querySelector("input[name=address]");let d=!0,c=[];const s=(e,t)=>{for(let o of e.children)o.disabled=!t},l=()=>{t.contains(t.querySelector(".map__card"))&&t.removeChild(t.querySelector(".map__card"))},u=e=>{window.util.removeAdPins();let n=new DocumentFragment;e.forEach((e=>{const a=window.renderPin(e);n.append(a),a.addEventListener("click",(()=>{Array.from(o.children).forEach((e=>{e.classList.contains("map__pin--active")&&e.classList.remove("map__pin--active")})),a.classList.add("map__pin--active"),l(),r.before(window.renderCard(e));const n=t.querySelector(".map__card"),i=n.querySelector(".popup__close"),d=()=>{n.remove(),a.classList.remove("map__pin--active"),document.removeEventListener("keydown",c)},c=e=>{window.util.escPress(e,d)};i.addEventListener("click",(()=>{d()})),document.addEventListener("keydown",c)}))})),o.append(n)},p=window.debounce((()=>{l(),u(window.filter.getFilterAds(c))})),m=e=>{c=e,u(window.filter.getFilterAds(c))},f=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; color: white",t.style.position="fixed",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},y=()=>{!1===d&&(a.classList.remove("ad-form--disabled"),t.classList.remove("map--faded"),s(a,!0),d=!0,window.form.onValidateGuests(),window.form.onValidatePrice(),i.value=v(),window.backend.load(m,f),s(window.filter.mapForm,!0))},v=()=>`${Math.floor(parseInt(n.style.left,10)+32.5)},\n  ${d?Math.floor(parseInt(n.style.top,10)+e+16):Math.floor(parseInt(n.style.top,10)+32.5)}`,w=(e,t,o)=>o<e?e:o>t?t:o;n.addEventListener("mousedown",(e=>{1===e.which&&y();let t={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=t.x-e.clientX,r=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const a=0-Math.floor(32.5),d=1200-Math.floor(32.5),c=n.offsetLeft-o,s=n.offsetTop-r;n.style.top=w(49,549,s)+"px",n.style.left=w(a,d,c)+"px",i.value=v()},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)})),n.addEventListener("click",(()=>{y()})),window.filter.mapForm.addEventListener("change",p),window.map={map:t,disablePage:()=>{a.classList.add("ad-form--disabled"),t.classList.add("map--faded"),s(a,!1),s(window.filter.mapForm,!1),d=!1,i.value=v()}}})(),window.map.disablePage()})();